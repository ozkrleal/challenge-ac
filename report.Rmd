---
title: "Report"
author: "Oscar Leal"
date: "3/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
library(tidyverse)
library(Hmisc)
library(ggplot2)
library(dplyr)
library(tidyr)
library(janitor)
library(plotly)
library(TSstudio)
library(data.table)
library(lubridate)
library(highcharter)
library(purrr)


library(DataExplorer)
```


## Introduction of *http://archive.ics.uci.edu/ml/machine-learning-databases/00502/* dataset.

Transactions occurring for a UK-based and registered, non-store online retail between 01/12/2009 and 09/12/2010.

Changing format for a more lightweight solution.

```{r}
#data <- readxl::read_xlsx("../online_retail_II.xlsx")

#saveRDS(data, file = "online_retail_II.rds")

```

Reading data.

```{r, include = FALSE}
data <- readRDS("online_retail_II.rds")
```

```{r}
colnames(data)
```

InvoiceNo: Invoice number. Nominal. A 6-digit integral number uniquely assigned to each transaction. If this code starts with the letter 'c', it indicates a cancellation.

StockCode: Product (item) code. Nominal. A 5-digit integral number uniquely assigned to each distinct product.

Description: Product (item) name. Nominal.

Quantity: The quantities of each product (item) per transaction. Numeric.

InvoiceDate: Invoice date and time. Numeric. The day and time when a transaction was generated.

UnitPrice: Unit price. Numeric. Product price per unit in sterling (Â£).

CustomerID: Customer number. Nominal. A 5-digit integral number uniquely assigned to each customer.

Country: Country name. Nominal. The name of the country where a customer resides.

```{r}
# some basic cleaning and factoring these columns for easier visualization of ratios
data <- data %>% clean_names()
data$description <- as.factor(data$description)
data$description <- fct_explicit_na(data$description)
data$country <- as.factor(data$country)
data$customer_id <- fct_explicit_na(as.factor(data$customer_id))
data$stock_code <- fct_explicit_na(as.factor(data$stock_code))


summary(data)
tail(data)
str(data)

#data explorer report
#DataExplorer::create_report(data)

```

```{r}
#here we notice that quantity can be negative. this indicates it should be a good idea to create a total price value that multiplies qty * price
data %>% filter(startsWith(invoice,"C")) %>% filter(stock_code == "22087")


data <- data %>% mutate(total_price = quantity * price)
```

## Comparing daily turnover of online retailer platform in 2009 and 2010 December.

What we can see here is that:
- in December 2009, there were sales up until the 23rd of December
- in December 2010 sales were made only until the 9th of December. It suggests there might be missing data from the last days of 2010
- We can also deduce that this online retail stops working from Christmas until January.

```{r, echo = FALSE}
# filters for only december
decembercomparison2009 <- data %>% filter(month(invoice_date) == 12 & (year(invoice_date) %in% c(2009))) %>% mutate(day = lubridate::day(invoice_date), year = year(invoice_date)) %>% group_by(day, year) %>% summarise(daily_sales=sum(total_price)) %>% ungroup()

decembercomparison2009 <- add_row(decembercomparison2009, day = 24:31, year = 2009, daily_sales = 0)

decembercomparison2010 <- data %>% filter(month(invoice_date) == 12 & (year(invoice_date) %in% c(2010))) %>% mutate(day = lubridate::day(invoice_date), year = year(invoice_date)) %>% group_by(day, year) %>% summarise(daily_sales=sum(total_price)) %>% ungroup()

decembercomparison2010 <- add_row(decembercomparison2010, day = 10:31, year = 2010, daily_sales = 0)

decembercomparison2009 <- decembercomparison2009 %>% mutate( date = as.Date(ymd(paste0(year, "-12-", day)))) %>% select(daily_sales, date)
decembercomparison2010 <- decembercomparison2010 %>% mutate( date = as.Date(ymd(paste0(year, "-12-", day)))) %>% select(daily_sales, date)
```


```{r}
ts_plot(decembercomparison2009, Ytitle = "Total Sales", line.mode = "lines+markers")
```

```{r}
ts_plot(decembercomparison2010, Ytitle = "Total Sales", line.mode = "lines+markers")
```

## Visualizing distribution of daily purchases

Here we see the amount of different items per invoice per day for December 2009. 

```{r}
fntltp <- JS("function(){
  return this.point.x + ' ' +  this.series.yAxis.categories[this.point.y] + ':<br>' +
  Highcharts.numberFormat(this.point.value, 2);
}")


data %>% filter(month(invoice_date) == 12 & (year(invoice_date) %in% c(2009))) %>% mutate(day = lubridate::day(invoice_date), year = year(invoice_date)) %>% group_by(invoice, as.factor(day)) %>% mutate(sales_per_invoice = sum(total_price))%>% ungroup() %>% group_by(day) %>% count(invoice) %>% arrange(day, -n) %>% ungroup() %>% hchart("heatmap", hcaes(x = day, y = invoice, value = n)) %>% 
  hc_yAxis(reversed = TRUE, offset = -20, tickLength = 0,
           gridLineWidth = 0, minorGridLineWidth = 0,
           labels = list(style = list(fontSize = "8px"))) %>%  
  hc_tooltip(formatter = fntltp) %>% 
  hc_size(height = 1000)

```

## Here we see the amount of different items per invoice per day for December 2010.

```{r}
data %>% filter(month(invoice_date) == 12 & (year(invoice_date) %in% c(2010))) %>% mutate(day = lubridate::day(invoice_date), year = year(invoice_date)) %>% group_by(invoice, as.factor(day)) %>% mutate(sales_per_invoice = sum(total_price))%>% ungroup() %>% group_by(day) %>% count(invoice) %>% arrange(day, -n) %>% ungroup() %>% hchart("heatmap", hcaes(x = day, y = invoice, value = n)) %>% 
  hc_yAxis(reversed = TRUE, offset = -20, tickLength = 0,
           gridLineWidth = 0, minorGridLineWidth = 0,
           labels = list(style = list(fontSize = "8px"))) %>%  
  hc_tooltip(formatter = fntltp) %>% 
  hc_size(height = 1000)

```

## Top 20 favorite profit maker friends for both December's (2009 and 2010).

```{r}
data %>% filter(month(invoice_date) == 12 & (year(invoice_date) %in% c(2009, 2010))) %>% mutate(day = lubridate::day(invoice_date), year = year(invoice_date)) %>% group_by(customer_id, as.factor(day), year) %>% summarise(sales_per_invoice = sum(total_price)) %>% ungroup() %>% arrange(-sales_per_invoice) %>% head(20)
```

## Top 10 selling items in the two years' Decembers.

```{r}
data %>% filter(month(invoice_date) == 12 & (year(invoice_date) %in% c(2009, 2010))) %>% mutate(day = lubridate::day(invoice_date), year = year(invoice_date)) %>% group_by(invoice, as.factor(day)) %>% mutate(sales_per_invoice = sum(total_price)) %>% ungroup() %>% count(description) %>% arrange(-n) %>% head(10) %>%
  hchart(type = "bar", hcaes(x = description, y = n))

```

## Top 20 selling items in the whole dataset.

```{r}
head(summary(data$description), 20)
```

## Customer concentration

```{r}
str(data)
data %>% 
```


## Amount of different item orders by country

```{r}
countryfreq <- summary(data$country)
countries <- stack(countryfreq)

countries %>% rename(country = ind, n = values) %>% arrange(-n)
```